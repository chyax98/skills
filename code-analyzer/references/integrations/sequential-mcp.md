# Sequential MCP 集成指南

## 简介

Sequential MCP 是一个多步推理工具,用于:

- 复杂问题的逐步推理
- 需求验证的逻辑推导
- 风险评估的综合判断

## 使用场景

在 code-analyzer 的以下步骤中使用:

| 步骤 | 用途 | 推理任务 |
|------|------|---------|
| Step 4: 需求验证 | 验证需求完整性 | 多步推理验证 |
| Step 5: 影响分析 | 推导影响范围 | 调用链推理 |
| Step 6: 风险评估 | 综合风险判断 | 多维度风险分析 |

## 推理模式

### 1. 需求验证推理

**用途**: 验证代码是否完整实现需求

**推理链示例**:

```
需求: "支持手机号登录"

推理步骤:
1. 是否有接收手机号的接口?
   → 检查: UserController.loginByPhone()
   → 结果: ✅ 是

2. 是否验证手机号格式?
   → 检查: 正则表达式验证
   → 结果: ✅ 是

3. 是否发送验证码?
   → 检查: SmsService.sendSmsCode()
   → 结果: ✅ 是

4. 是否验证验证码?
   → 检查: UserService.verifySmsCode()
   → 结果: ✅ 是

5. 是否创建登录会话?
   → 检查: sessionManager.createSession()
   → 结果: ✅ 是

6. 是否有验证码过期检查?
   → 检查: 未找到相关代码
   → 结果: ❌ 否 (缺失)

结论: ⚠️ 部分实现 (83% 完整度, 缺少验证码过期检查)
```

**Sequential MCP 调用**:

```
任务: 需求完整性验证

输入:
- 需求: "支持手机号登录"
- 代码: [UserController, UserService, SmsService 相关代码]

推理目标:
1. 识别需求的核心功能点
2. 逐一验证代码是否实现
3. 评估实现的完整性
4. 给出验证结论

请使用多步推理,逐步验证每个功能点。
```

### 2. 影响范围推导

**用途**: 推导代码变更的间接影响

**推理链示例**:

```
变更: UserService.login() 方法修改

推理步骤:
1. 谁直接调用了 UserService.login()?
   → UserController.login()
   → 影响: 🔴 直接影响

2. UserController 被谁调用?
   → API Gateway
   → 影响: 🔴 前端登录功能

3. 还有谁使用 UserService?
   → OrderService.getUserInfo()
   → 影响: 🟡 间接影响 (订单创建需要用户信息)

4. OrderService 被谁调用?
   → OrderController
   → 影响: 🟡 订单创建流程

5. 是否影响其他模块?
   → AdminService.validateUser()
   → 影响: 🟢 低风险 (管理后台, 不同登录入口)

结论:
- 直接影响: UserController, 前端登录
- 间接影响: OrderService, 订单创建
- 低风险影响: AdminService, 管理后台
```

**Sequential MCP 调用**:

```
任务: 影响范围推导

输入:
- 变更: UserService.login() 方法修改
- 调用链: [Serena MCP 提供的调用关系]

推理目标:
1. 识别直接调用者
2. 递归追踪间接调用者
3. 评估每层调用的影响程度
4. 生成影响范围报告

请使用多层推理,追踪完整的调用链。
```

### 3. 风险综合评估

**用途**: 综合多个维度评估风险

**推理链示例**:

```
风险评估任务

输入数据:
- 缺陷: 2个 Blocker, 1个 Critical, 2个 Major
- 影响: 3个直接模块, 2个间接模块
- 需求: 75% 覆盖率 (3/4 已实现)

推理步骤:
1. 评估缺陷风险
   → 分数: 2×10 + 1×5 + 2×2 = 29分
   → 等级: 🔴 极高风险

2. 评估影响范围风险
   → 直接影响 3 个模块 (≤3个)
   → 等级: 🟢 低风险

3. 评估需求覆盖风险
   → 覆盖率 75% (70-90%)
   → 等级: 🟡 中风险

4. 综合风险判断
   → 取最高风险: 🔴 极高风险
   → 主要风险源: 缺陷 (2个 Blocker)

5. 优先级排序
   → Priority 1: 修复 Blocker 级缺陷
   → Priority 2: 补充缺失需求 (25%)
   → Priority 3: 修复其他缺陷

结论: 🔴 高风险, 建议修复 Blocker 缺陷后再提测
```

**Sequential MCP 调用**:

```
任务: 综合风险评估

输入:
- 缺陷数据: [缺陷清单]
- 影响数据: [影响范围]
- 需求数据: [需求覆盖情况]

推理目标:
1. 分别评估三个维度的风险
2. 计算综合风险等级
3. 识别最高风险点
4. 提供优先级排序的测试建议

请使用多维度推理,综合评估风险。
```

## 推理模板

### Template 1: 需求验证

```markdown
### 需求验证推理

**需求**: {需求描述}

**代码**: {相关代码片段}

#### 推理任务

1. 提取需求的核心功能点 (3-5个)
2. 对每个功能点:
   - 查找对应的代码实现
   - 评估实现的完整性 (0-100%)
   - 识别缺失的部分
3. 综合评估需求覆盖率
4. 给出验证结论 (已实现/部分实现/未实现)

#### 推理步骤

步骤 1: 功能点提取
...

步骤 2: 逐一验证
...

步骤 3: 完整性评估
...

#### 结论

{验证结论}
```

### Template 2: 影响推导

```markdown
### 影响范围推导

**变更**: {变更描述}

**调用链数据**: {Serena MCP 提供}

#### 推理任务

1. 识别直接调用者 (一层)
2. 递归追踪间接调用者 (多层)
3. 对每层调用:
   - 评估影响程度 (直接/间接/低风险)
   - 分析影响原因
4. 生成影响范围报告

#### 推理步骤

步骤 1: 直接影响
...

步骤 2: 间接影响 (二层)
...

步骤 3: 间接影响 (三层)
...

#### 结论

{影响范围报告}
```

### Template 3: 风险评估

```markdown
### 综合风险评估

**缺陷数据**: {缺陷清单}
**影响数据**: {影响范围}
**需求数据**: {需求覆盖}

#### 推理任务

1. 评估缺陷风险 (计算分数)
2. 评估影响范围风险 (模块数量)
3. 评估需求覆盖风险 (覆盖率)
4. 综合判断风险等级 (取最高)
5. 提供优先级建议

#### 推理步骤

步骤 1: 缺陷风险
...

步骤 2: 影响范围风险
...

步骤 3: 需求覆盖风险
...

步骤 4: 综合判断
...

步骤 5: 优先级排序
...

#### 结论

{风险评估报告}
```

## 使用最佳实践

### 1. 明确推理目标

✅ 好的推理任务:

```
任务: 验证"支持手机号登录"需求是否完整实现

推理步骤:
1. 识别需求的核心功能点
2. 逐一验证代码实现
3. 评估完整性
```

❌ 不好的推理任务:

```
任务: 分析代码  # 太模糊
```

### 2. 提供充分上下文

```
输入:
- 需求文档: [详细描述]
- 变更代码: [Git diff]
- 调用链: [Serena MCP 提供]
```

### 3. 分步推理

复杂任务分解为多个小步骤:

```
步骤 1: 识别直接影响
步骤 2: 追踪间接影响 (二层)
步骤 3: 追踪间接影响 (三层)
步骤 4: 综合评估
```

## 性能优化

### 1. 缓存推理结果

相同的推理任务,复用结果。

### 2. 并行推理

独立的推理任务可以并行执行。

### 3. 渐进式推理

从简单到复杂,逐步深入。

## 限制和注意事项

### 1. 推理质量

- 依赖输入数据质量
- 复杂逻辑可能需要人工确认
- 边界情况需要额外验证

### 2. 推理时间

- 多步推理需要时间
- 复杂推理链较慢
- 建议按需使用

### 3. 推理范围

- 只能基于现有信息推理
- 无法推理未知的业务规则
- 运行时行为难以推理

## 集成清单

在实现 code-analyzer 时:

- [x] Step 4: 需求验证 - 多步推理验证需求完整性
- [x] Step 5: 影响分析 - 推导影响范围
- [x] Step 6: 风险评估 - 综合风险判断

## 参考资源

- Sequential MCP 官方文档
- Chain-of-Thought 推理模式
- 多步推理最佳实践

---

**版本**: 1.0.0
**适用**: Sequential MCP v1.x
**更新**: 2025-10-26
