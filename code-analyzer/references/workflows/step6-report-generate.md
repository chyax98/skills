# Step 6: 风险评估与报告生成

## 目标

综合前5步的分析结果,生成面向测试工程师的测试分析报告 (Markdown 格式)。

## 输入数据

汇总前5步的数据:

- Step 1: 代码变更信息
- Step 2: 技术栈识别结果
- Step 3: 缺陷检测清单
- Step 4: 需求验证结果
- Step 5: 影响范围分析

## 风险评估

### 1. 缺陷风险评分

根据缺陷严重度和数量计算风险分数:

```
风险分数 = Blocker * 10 + Critical * 5 + Major * 2 + Minor * 1

示例:
- 2个 Blocker + 1个 Critical + 2个 Major = 20 + 5 + 4 = 29分
```

**风险等级**:

- 0-5分: 🟢 低风险
- 6-15分: 🟡 中风险
- 16-30分: 🟠 高风险
- 30分以上: 🔴 极高风险

### 2. 影响范围风险

根据影响模块数量评估:

- 直接影响模块 ≤ 3个: 低风险
- 直接影响模块 4-6个: 中风险
- 直接影响模块 > 6个: 高风险

### 3. 需求覆盖风险

根据需求完成度评估:

- 需求覆盖率 ≥ 90%: 低风险
- 需求覆盖率 70-90%: 中风险
- 需求覆盖率 < 70%: 高风险

### 4. 综合风险等级

取三者中最高风险等级作为综合评估。

## 报告生成

### 报告结构

```markdown
# 测试分析报告: {需求名称}

## 📋 基本信息

## 🔴 发现缺陷

## 🎯 需求实现情况

## 📊 影响范围分析

## ⚠️ 风险评估

## 💡 测试重点建议
```

### 详细模板

**完整的测试分析报告模板**: @references/specs/report-format.md

## 报告保存

### 保存路径

报告保存到**被分析项目的根目录**:

```
{被分析项目根目录}/analysis-reports/{需求名称}/{分支名}-{日期时间}.md
```

**重要说明**:
- 保存在**被分析的实际项目目录**下,不是 code-analyzer skill 目录
- 例如分析 `/home/user/myproject/` 时,报告保存到该项目下

**示例**:

```
./analysis-reports/用户登录优化/feature-login-20251026-153022.md
```

### 文件命名规则

```
{分支名}-{年月日}-{时分秒}.md

示例:
- feature-login-20251026-153022.md
- main-20251026-160030.md
```

### 目录组织

```
analysis-reports/
├── 用户登录优化/
│   ├── feature-login-20251026-153022.md
│   └── feature-login-20251026-170045.md  (修复后重新分析)
├── 支付流程优化/
│   └── feature-payment-20251027-100030.md
└── README.md  (索引文件)
```

## 报告内容生成

### 1. 基本信息部分

```markdown
## 📋 基本信息

- **需求名称**: 用户登录优化
- **分析分支**: feature/login-opt
- **对比基准**: main
- **提交数量**: 3 次
- **变更文件**: 8 个 (新增 2 个, 修改 6 个)
- **变更行数**: +245 / -67
- **分析时间**: 2025-10-26 15:30:22
- **技术栈**: Java + SpringBoot 3.2.0
```

### 2. 缺陷清单部分

按严重度分组展示:

```markdown
## 🔴 发现缺陷 (5个)

### 🔴 Blocker - 阻断级 (2个)

#### 1. SQL 注入风险

- **文件**: `src/main/java/UserRepository.java:78`
- **代码**:
  ```java
  String sql = "SELECT * FROM user WHERE name = '" + name + "'";
  ```
- **问题**: 使用字符串拼接构造 SQL,存在注入风险
- **影响**: 恶意输入可绕过认证,访问或篡改数据
- **修复建议**: 使用参数化查询
  ```java
  @Query("SELECT * FROM user WHERE name = :name")
  User findByName(@Param("name") String name);
  ```
- **参考**: OWASP A03:2021 - Injection

### 🟠 Critical - 严重级 (1个)

#### 3. N+1 查询问题

...

### 🟡 Major - 重要级 (2个)

...
```

### 3. 需求实现部分

```markdown
## 🎯 需求实现情况

### ✅ 已实现 (3/4 - 75%)

1. **支持手机号登录**
   - `UserController.loginByPhone()` - 接收手机号参数
   - `UserService.validatePhone()` - 验证手机号格式
   - `SmsService.sendSmsCode()` - 发送验证码

2. **支持验证码登录**
   - `SmsService.sendSmsCode()` - 发送验证码
   - `UserService.verifySmsCode()` - 验证验证码

3. **保留原有用户名密码登录**
   - `UserController.loginByPassword()` - 原有方法保持不变

### ❌ 未实现 (1/4 - 25%)

1. **添加登录失败次数限制**
   - 未找到相关代码实现
   - 风险: 无法防止暴力破解

### ⚠️ 多余实现 (需确认)

1. **第三方登录 (微信、支付宝)**
   - `UserController.loginByThirdParty()`
   - 需求文档中未提及,需与产品确认是否必要
```

### 4. 影响范围部分

```markdown
## 📊 影响范围分析

### 直接影响模块 (3个)

1. **UserController**
   - 新增: `loginByPhone()`, `sendSmsCode()`
   - 影响: 用户登录接口变更

2. **UserService**
   - 修改: 登录逻辑,添加手机号验证
   - 影响: 核心业务逻辑变更

3. **SmsService** (新增)
   - 新增: 验证码发送服务
   - 影响: 新增外部依赖 (短信服务商)

### 间接影响模块 (2个)

1. **OrderController**
   - 调用路径: `OrderController → UserService`
   - 影响原因: 订单创建依赖用户登录态

2. **AdminController**
   - 调用路径: `AdminController → UserService`
   - 影响原因: 管理员权限验证依赖 UserService

### 回归测试范围建议

#### 🔴 必须测试 (Priority 1)

1. **用户登录功能**
   - 手机号登录 - 正常流程
   - 手机号登录 - 异常场景 (格式错误、验证码错误、过期)
   - 用户名密码登录 - 确保原有功能正常
   - 验证码发送 - 限流、重复发送

2. **用户信息查询**
   - 登录后获取用户信息
   - Session 管理

#### 🟡 建议测试 (Priority 2)

3. **订单创建**
   - 验证登录态有效性
   - 订单创建流程

4. **管理后台登录**
   - 管理员登录功能
   - 权限验证

#### 🟢 可选测试 (Priority 3)

5. **用户相关报表**
   - 用户统计报表 (仅读取,低风险)
```

### 5. 风险评估部分

```markdown
## ⚠️ 风险评估

### 综合风险等级: 🔴 高风险

### 风险来源

1. **缺陷风险: 🔴 极高风险 (29分)**
   - 2个 Blocker 级缺陷 (SQL注入、敏感信息泄露)
   - 1个 Critical 级缺陷 (N+1查询)
   - 缺陷分数: 2×10 + 1×5 + 2×2 = 29分

2. **影响范围风险: 🟡 中风险**
   - 直接影响 3 个模块
   - 间接影响 2 个模块
   - 核心登录逻辑变更,影响面较大

3. **需求覆盖风险: 🟡 中风险**
   - 需求覆盖率: 75% (3/4)
   - 登录失败次数限制未实现
   - 存在未明确的多余实现

### 测试建议

#### 🔴 优先级 1 - 立即处理

1. **修复 Blocker 级缺陷**
   - 修复 SQL 注入风险 (UserRepository.java:78)
   - 移除硬编码敏感信息

2. **补充缺失需求**
   - 实现登录失败次数限制
   - 或明确说明不需要此功能

#### 🟠 优先级 2 - 提测前处理

3. **修复 Critical 级缺陷**
   - 优化 N+1 查询问题 (OrderService.java:45)

4. **全面测试登录功能**
   - 覆盖所有登录场景 (正常、异常、边界)

#### 🟡 优先级 3 - 计划处理

5. **回归测试依赖模块**
   - 测试订单创建、用户信息查询
   - 确保原有功能不受影响

6. **确认多余实现**
   - 与产品确认第三方登录是否必要
```

### 6. 测试重点建议部分

```markdown
## 💡 测试重点建议

### 安全测试

- **SQL 注入测试**: 在所有输入点尝试注入攻击
- **XSS 测试**: 验证码、手机号等输入的 XSS 防护
- **认证绕过测试**: 尝试未登录访问受保护接口
- **暴力破解测试**: (待实现登录失败限制后)

### 性能测试

- **并发登录测试**: 1000+ 用户同时登录
- **验证码发送压力测试**: 验证限流机制
- **数据库性能**: 监控 N+1 查询修复后的性能

### 功能测试

- **手机号登录**: 各种场景 (正常、格式错误、验证码错误、过期、重复发送)
- **原有功能兼容**: 用户名密码登录不受影响
- **Session 管理**: 登录态有效性、超时、并发登录

### 兼容性测试

- **接口兼容**: 原有登录接口是否仍然可用
- **数据兼容**: 现有用户是否可以正常登录
- **客户端兼容**: 移动端、Web端是否都支持新登录方式
```

## 生成报告示例

完整示例见 SKILL.md 中的"报告示例"部分。

## MCP 工具使用

### Sequential MCP

**风险推理**:

```
基于以下数据进行风险评估:
- 缺陷: 2个 Blocker, 1个 Critical, 2个 Major
- 影响: 3个直接模块, 2个间接模块
- 需求: 75% 覆盖率

任务:
1. 计算综合风险等级
2. 识别最高风险点
3. 提供优先级排序的测试建议
```

## 注意事项

1. **报告语言**: 面向测试工程师,避免过于技术化的术语
2. **可操作性**: 每个建议都应该是可执行的测试任务
3. **优先级明确**: 清晰标注哪些必须测,哪些建议测
4. **本地保存**: 报告保存在项目本地,便于版本管理和追溯

## 常见问题

**Q: 报告格式为什么是 Markdown?**

A: Markdown 易读易写,可以直接在 Git 仓库中版本管理,也可以方便地转换为 HTML/PDF。

**Q: 如何追踪多次分析的变化?**

A: 同一需求的多次分析保存在同一目录下,通过文件名时间戳区分。

**Q: 报告可以自定义吗?**

A: 可以,修改 @references/specs/report-format.md 模板即可。

## 总结

完成此步骤后,测试工程师可以:

1. 了解代码变更的全貌
2. 识别需要修复的缺陷
3. 明确需要测试的范围和优先级
4. 评估提测的风险

---

**工作流结束** - 测试分析报告已生成
